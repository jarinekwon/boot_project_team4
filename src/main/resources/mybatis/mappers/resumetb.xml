<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boot.dao.ResumetbDAO">
	<insert id="resumesave">
		<selectKey keyProperty="prono" resultType="int" order="BEFORE">
			select ifnull(max(prono), 0) + 1 as prono
			from resumetb
			where puserid = #{puserid}
		</selectKey>
		insert into resumetb (puserid, prono, protitle, prstitle, pname, gendr, birdy, imgcd, email, phone, paddr,
							  prsup, prsself, classgb, shoolnm, grade, gradesta, majornm, credit, score,
							  sdate, edate, salary, armgu, propo, proself, prcnt, adate)
					values (#{puserid}, #{prono}, #{protitle}, #{prstitle}, #{pname}, #{gendr}, #{birdy}, #{imgcd}, #{email}, #{phone}, #{paddr},
							#{prsup}, #{prsself}, #{classgb}, #{shoolnm}, #{grade}, #{gradesta}, #{majornm}, #{credit}, #{score},
							#{sdate}, #{edate}, #{salary}, #{armgu}, #{propo}, #{proself}, #{prcnt}, now()
							)
	</insert>
	
	<!-- 페이징처리한다고 수정 -->
	<select id="resumelist" resultType="com.boot.dto.ResumetbDTO">
		select puserid, prono, protitle, prstitle, imgno, usetb, gubun, uuid, uploadpath, adate, rn
		from
		(
			select puserid, prono, protitle, prstitle, imgno, usetb, gubun, uuid, uploadpath, adate, rn
			from
			(
				select a.puserid, a.prono, a.protitle, a.prstitle, b.imgno, b.usetb, b.gubun, b.uuid, b.uploadpath, a.adate,
					   row_number() over(order by a.adate desc) as rn
			    from resumetb a
			    left outer join imgtb b on (b.usetb = 'resumetb' and b.gubun = concat(a.puserid, '_', a.prono))
			) as a
			where puserid = #{puserid}
		) as a
		where rn between ((#{pageNum} - 1) * #{amount}) + 1 and #{pageNum} * #{amount};
	</select>
	
	<!-- 페이징 카운터 -->
	<select id="getTotalCount" resultType="int">
		select count(*)
        from
			(	
				select a.puserid, a.prono, a.protitle, a.prstitle, b.imgno, b.usetb, b.gubun, b.uuid, b.uploadpath, a.adate
			    from resumetb a
			    left outer join imgtb b on (b.usetb = 'resumetb' and b.gubun = concat(a.puserid, '_', a.prono))
			) as a
		where puserid = #{puserid} 
	</select>
	
	<!--   resumelist dao이름 맞춰줘야됨  -->
	<select id="resumeselect" resultType="com.boot.dto.ResumetbDTO">
		select puserid, prono, protitle, prstitle, pname, gendr, birdy, imgcd, email, 
			   phone, paddr, prsup, prsself, classgb, shoolnm, grade, gradesta, majornm,
			   credit, score, sdate, edate, salary, armgu, propo, proself, prcnt, adate, mdate,
		       imgno, usetb, gubun, uuid, uploadpath
		from
		(
			select a.puserid, a.prono, a.protitle, a.prstitle, a.pname, a.gendr, a.birdy, a.imgcd, a.email,
				   a.phone, a.paddr, a.prsup, a.prsself, a.classgb, a.shoolnm, a.grade, a.gradesta, a.majornm,
				   a.credit, a.score, a.sdate, a.edate, a.salary, a.armgu, a.propo, a.proself, a.prcnt, a.adate, a.mdate,
		           b.imgno, b.usetb, b.gubun, b.uuid, b.uploadpath
			from resumetb a
		    left outer join imgtb b on (b.usetb = 'resumetb' and gubun = concat(a.puserid, '_', a.prono))
		) as a
		where puserid = #{puserid} and prono = #{prono}
	</select>
	
	<select id="getMaxProno" resultType="int">
		select max(prono) as prono
		from resumetb
		where puserid = #{puserid} 
	</select>
	
	<delete id="resumedelete">
		delete from resumetb
		where puserid = #{puserid} and prono = ${prono}
	</delete>
	
	<select id="resume_view">
		select puserid, prono, protitle, prstitle, pname, gendr, birdy, imgcd, email, 
			   phone, paddr, prsup, prsself, classgb, shoolnm, grade, gradesta, majornm,
			   credit, score, sdate, edate, salary, armgu, propo, proself, prcnt, adate, mdate,
			   imgno, usetb, gubun, uuid, uploadpath
		from
		(
			select a.puserid, a.prono, a.protitle, a.prstitle, a.pname, a.gendr, a.birdy, a.imgcd, a.email, 
				   a.phone, a.paddr, a.prsup, a.prsself, a.classgb, a.shoolnm, a.grade, a.gradesta, a.majornm,
				   a.credit, a.score, a.sdate, a.edate, a.salary, a.armgu, a.propo, a.proself, a.prcnt, a.adate, a.mdate,
				   b.imgno, b.usetb, b.gubun, b.uuid, b.uploadpath
			from resumetb a
			left outer join imgtb b on (b.usetb = 'resumetb' and b.gubun = concat(a.puserid, '_', a.prono))
		) as a
		where puserid = #{puserid} and prono = #{prono}
	</select>
	
	<select id="getResumeList" resultType="com.boot.dto.ResumetbDTO">
        SELECT prono, protitle
        FROM resumetb
        WHERE puserid = #{puserid}
    </select>
	
	<update id="resumeupdate">
		update resumetb set protitle = #{protitle}, prstitle = #{prstitle}, pname = #{pname}, gendr = #{gendr}, birdy = #{birdy}, imgcd = #{imgcd}, email = #{email}, 
						    phone = #{phone}, paddr = #{paddr}, prsself = #{prsself}, classgb = #{classgb}, shoolnm = #{shoolnm}, gradesta = #{gradesta}, majornm = #{majornm}, 
						    credit = #{credit}, score = #{score}, sdate = #{sdate}, edate = #{edate}, salary = #{salary}, armgu = #{armgu}, proself = #{proself}, 
        					mdate = CURRENT_TIMESTAMP 
		where puserid = #{puserid} and prono = #{prono} 
	</update>
	
</mapper>











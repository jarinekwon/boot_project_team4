<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.CalltbDAO">
	<sql id="searchquery">
		<if test='type == "all" and keyword != ""'>
        	and calltitle like concat('%', #{keyword}, '%') or callcontent like concat('%', #{keyword}, '%')
      	</if>
		<if test='type == "T" and keyword != ""'>
			and calltitle like concat('%', #{keyword}, '%')
		</if>
		<if test='type == "C" and keyword != ""'>
			and callcontent like concat('%', #{keyword}, '%')
		</if>
	</sql>
    <select id="calllist" resultType="com.boot.dto.CalltbDTO">
    	select callno, authorid, calltitle, callcontent, callyn, adate, rn
		from
		(
			select callno, authorid, calltitle, callcontent, callyn, adate,
				   row_number() over(order by callno desc) as rn
			from calltb
			where authorid = #{authorid}
		) as a
    	where rn between ((#{pageNum} - 1) * #{amount}) + 1 and #{pageNum} * #{amount}
    	<include refid="searchquery"></include>
    </select>
    
	<select id="getTotalCount" resultType="int">
		select count(*)
		from
		(
			select callno, authorid, calltitle, callcontent, callyn, adate,
				   row_number() over(order by callno desc) as rn
			from calltb
			where authorid = #{authorid}
		) as a
		where 1=1
    	<include refid="searchquery"></include>
    </select>
    
    <insert id="callwrite">
	    <selectKey keyProperty="callno" resultType="int" order="BEFORE">
	   		select ifnull(max(callno), 0) + 1 as callno
			from calltb
			where authorid = #{authorid}
		</selectKey>
		insert into calltb (callno, authorid, calltitle, callcontent, adate)
	        	values(#{callno}, #{authorid}, #{calltitle}, #{callcontent}, now())
    </insert>
    
    <select id="callselect" resultType="com.boot.dto.CalltbDTO">
		select callno, authorid, calltitle, callcontent, callyn, callreply, adate
		from calltb
		where callno = #{callno} and authorid = #{authorid}
    </select>
    
</mapper>